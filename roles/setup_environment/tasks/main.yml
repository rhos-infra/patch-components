---
- name: set branch names for component and dist-git to be checked out and patched
  vars:
      _branch: "{%- if install.branch is defined -%} {{ install.branch + '-' }} {%- endif -%}"
  set_fact:
      component_branch_to_patch: "{{ _branch }}rhos-{{ install.component.version }}.0-patches"
      dit_git_branch_to_patch: "{{ _branch }}rhos-{{ install.component.version }}.0-rhel-{{ ansible_distribution_version|int }}"
  #      dist_git_branch_to_patch: "{{ install.branch is defined || rhos-{{ install.component.version }}.0-rhel-{{ ansible_distribution_version|int }} "
  tags: set-branches

- name: print branches that will be patched and built
  debug:
      msg: "component_branch_to_patch: {{ component_branch_to_patch }}, dit_git_branch_to_patch: {{ dit_git_branch_to_patch }}"
  tags: set-branches

- name: Clean previous and create tmp_dir for all the building
  register: tmp_dir_shell
  shell: "rm -rf tmp.patch_rpm*; mktemp -d --tmpdir tmp.patch_rpm.XXXXXXXX"
  args:
    warn: no
  tags: skip_ansible_lint

- name: Set tmp_dir for all the building
  set_fact: tmp_dir="{{ ansible_env.HOME }}"
  tags:
      - odl-package-rpm
      - rpm
      - logs
      - patched-rpms-repo
      - build-opendaylight

- name: Remove and create logs dir
  file:
      path: "{{ tmp_dir }}/logs/"
      state: "{{ item }}"
  with_items:
    - absent
    - directory

- name: Remove dist-git folder
  file:
      path: "{{ tmp_dir}}/dist-git"
      state: absent

# To copy the component to remote host
- name: Install rsync
  become: yes
  yum:
    name='rsync'
    state=present

#synchronize:copy
- name: Copy component to remote host
  synchronize:
    src: "{{ item }}"
    dest: "{{ tmp_dir }}"
    use_ssh_args: "yes"
    rsync_opts: --quiet
  with_first_found:
    - "{{ install.component.path | default(omit) }}"
    - "{{ inventory_dir }}/{{ install.component.name }}"
    - "{{ inventory_dir }}/../{{ install.component.name }}"
    - "{{ inventory_dir }}/../../../{{ install.component.name }}"
    - "{{ playbook_dir }}/../{{ install.component.name }}"
