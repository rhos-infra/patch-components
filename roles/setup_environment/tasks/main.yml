---
# mock group is needed for the mockbuild
# without creating mock group, rdopkg will try to use root and ask for password
- name: Create mock group
  become: yes
  group:
    name=mock
    state=present

- name: Add ansible ssh user to mock group
  become: yes
  user:
    name="{{ ansible_user }}"
    groups=mock

- name: Clean previous and create tmp_dir for all the building
  register: tmp_dir_shell
  shell: "rm -rf tmp.patch_rpm*; mktemp -d --tmpdir tmp.patch_rpm.XXXXXXXX"
  args:
      warn: no
  tags: skip_ansible_lint

- name: Set tmp_dir for all the building
  set_fact: tmp_dir="{{ ansible_env.HOME }}"
  tags: always

- name: Remove and create logs dir
  file:
      path: "{{ tmp_dir }}/logs/"
      state: "{{ item }}"
  with_items:
      - absent
      - directory

- name: Remove dist-git folder
  file:
      path: "{{ tmp_dir }}/dist-git"
      state: absent

- name: Install python3 packages on RHEL8
  become: yes
  yum:
    name:
      - 'python3-devel'
      - 'python3-tox'
      - 'python3-testrepository'
      - 'python3-pip'
      - 'python3-py'
      - 'python3-virtualenv'
      - 'python3-pluggy'
    state: present
  when: ansible_os_family == "RedHat" and ansible_lsb.major_release|int == 8
  register: task_result
  until: task_result is success
  retries: 3
  delay: 3
